<!DOCTYPE html>

<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—×˜× ×•×¢×•× ×©×• - ×§×•×¨×¡ ××¨×™××œ ××—×–×•×¨ ×™×“</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Rubik', 'Varela Round', sans-serif;
        background: linear-gradient(135deg, #e8d5d3 0%, #f0e0de 50%, #f5ebe9 100%);
        min-height: 100vh;
        padding: 20px;
        direction: rtl;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .header {
        background: linear-gradient(135deg, #c9a5a0 0%, #d8b5b0 100%);
        border-radius: 20px;
        padding: 35px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 8px 30px rgba(201, 165, 160, 0.4);
        border: 3px solid #b89590;
    }

    .header h1 {
        color: #fff;
        font-size: 2.8em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .header-icon {
        font-size: 1.2em;
    }

    .header p {
        color: #fff;
        font-size: 1.3em;
        font-weight: 600;
    }

    .nav-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .nav-btn {
        background: linear-gradient(135deg, #c9a5a0 0%, #d8b5b0 100%);
        color: #fff;
        border: 2px solid #b89590;
        padding: 20px;
        border-radius: 15px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(201, 165, 160, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .nav-btn:hover {
        background: linear-gradient(135deg, #d8b5b0 0%, #e5c5c0 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(201, 165, 160, 0.4);
    }

    .nav-btn.active {
        background: linear-gradient(135deg, #a8807a 0%, #b89590 100%);
        border-color: #9a756f;
    }

    .content-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 30px rgba(201, 165, 160, 0.3);
        border: 2px solid #d8b5b0;
        display: none;
    }

    .content-section.active {
        display: block;
    }

    .section-title {
        color: #9a756f;
        font-size: 2em;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid #c9a5a0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
    }

    .form-group {
        margin-bottom: 20px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        color: #9a756f;
        font-weight: 600;
        font-size: 1.1em;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5c5c0;
        border-radius: 12px;
        font-size: 1em;
        font-family: inherit;
        background: white;
        transition: all 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: #c9a5a0;
        box-shadow: 0 0 0 3px rgba(201, 165, 160, 0.2);
    }

    textarea {
        resize: vertical;
        min-height: 100px;
    }

    .radio-group {
        display: flex;
        gap: 30px;
        margin-top: 10px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .radio-option input[type="radio"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #c9a5a0;
    }

    .radio-option label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
    }

    .submit-btn {
        background: linear-gradient(135deg, #c9a5a0 0%, #d8b5b0 100%);
        color: #fff;
        border: none;
        padding: 15px 40px;
        border-radius: 15px;
        font-size: 1.2em;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(201, 165, 160, 0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 auto;
    }

    .submit-btn:hover {
        background: linear-gradient(135deg, #d8b5b0 0%, #e5c5c0 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(201, 165, 160, 0.5);
    }

    .filter-section {
        background: linear-gradient(135deg, #faf5f4 0%, #f5ebe9 100%);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 2px solid #e5c5c0;
    }

    .filter-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #9a756f;
        margin-bottom: 15px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .filter-btn {
        background: linear-gradient(135deg, #c9a5a0 0%, #d8b5b0 100%);
        color: #fff;
        border: none;
        padding: 12px 25px;
        border-radius: 12px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-btn:hover {
        background: linear-gradient(135deg, #d8b5b0 0%, #e5c5c0 100%);
        transform: translateY(-2px);
    }

    .clear-filter-btn {
        background: linear-gradient(135deg, #e5c5c0 0%, #f0d5d0 100%);
        color: #8a6560;
        border: none;
        padding: 12px 25px;
        border-radius: 12px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
    }

    .clear-filter-btn:hover {
        background: linear-gradient(135deg, #f0d5d0 0%, #fae5e0 100%);
    }

    .table-wrapper {
        overflow-x: auto;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(201, 165, 160, 0.2);
        margin-top: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        min-width: 1300px;
    }

    th {
        background: linear-gradient(135deg, #c9a5a0 0%, #d8b5b0 100%);
        color: #fff;
        padding: 15px 10px;
        font-size: 1em;
        text-align: right;
        border-bottom: 3px solid #b89590;
        position: sticky;
        top: 0;
        white-space: nowrap;
        font-weight: 700;
    }

    td {
        padding: 12px 10px;
        border-bottom: 1px solid #f0e0de;
        color: #555;
    }

    tr:hover {
        background-color: #faf5f4;
    }

    .delete-btn {
        background: linear-gradient(135deg, #c9a5a0 0%, #d8b5b0 100%);
        color: #fff;
        border: none;
        padding: 8px 15px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
        white-space: nowrap;
        font-weight: 600;
    }

    .delete-btn:hover {
        background: linear-gradient(135deg, #a8807a 0%, #b89590 100%);
        transform: scale(1.05);
    }

    .message {
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
        display: none;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
        display: block;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #c9a5a0;
        font-size: 1.2em;
    }

    .stats-container {
        display: grid;
        gap: 30px;
    }

    .chart-section {
        background: linear-gradient(135deg, #faf5f4 0%, #f5ebe9 100%);
        padding: 25px;
        border-radius: 15px;
        border: 2px solid #e5c5c0;
        box-shadow: 0 5px 15px rgba(201, 165, 160, 0.2);
    }

    .chart-section h3 {
        color: #9a756f;
        font-size: 1.5em;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 700;
    }

    .soldier-search {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e5c5c0;
        margin-bottom: 25px;
    }

    .search-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5c5c0;
        border-radius: 12px;
        font-size: 1em;
        font-family: inherit;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #c9a5a0;
        box-shadow: 0 0 0 3px rgba(201, 165, 160, 0.2);
    }

    .search-results {
        margin-top: 20px;
    }

    .pie-chart-container {
        display: flex;
        gap: 30px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }

    .pie-chart {
        position: relative;
        width: 250px;
        height: 250px;
        flex-shrink: 0;
    }

    .pie-slice {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .pie-slice:hover {
        opacity: 0.8;
        transform: scale(1.05);
    }

    .soldier-details {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e5c5c0;
        min-width: 280px;
        max-width: 350px;
        flex-shrink: 0;
    }

    .soldier-details h4 {
        color: #9a756f;
        font-size: 1.3em;
        margin-bottom: 15px;
        font-weight: 700;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0e0de;
    }

    .detail-label {
        color: #b89590;
        font-weight: 600;
    }

    .detail-value {
        color: #555;
        font-weight: 500;
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    input[type="checkbox"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: #c9a5a0;
    }

    .checkbox-cell {
        text-align: center;
    }

    .not-relevant {
        color: #bbb;
        font-style: italic;
        font-size: 0.9em;
    }

    /* ××¡×š ×¡×™×¡××” */
    .login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #e8d5d3 0%, #f0e0de 50%, #f5ebe9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    }

    .login-screen.hidden {
        display: none;
    }

    .login-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 25px;
        padding: 45px 40px;
        box-shadow: 0 10px 40px rgba(201, 165, 160, 0.4);
        border: 3px solid #d8b5b0;
        max-width: 420px;
        width: 100%;
        text-align: center;
    }

    .login-icon {
        font-size: 3em;
        margin-bottom: 15px;
    }

    .login-card h1 {
        color: #9a756f;
        font-size: 2em;
        margin-bottom: 8px;
        font-weight: 700;
    }

    .login-card .login-subtitle {
        color: #b89590;
        font-size: 1.05em;
        margin-bottom: 30px;
        font-weight: 500;
    }

    .login-input {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e5c5c0;
        border-radius: 14px;
        font-size: 1.15em;
        font-family: inherit;
        text-align: center;
        letter-spacing: 3px;
        transition: all 0.3s ease;
        margin-bottom: 10px;
    }

    .login-input:focus {
        outline: none;
        border-color: #c9a5a0;
        box-shadow: 0 0 0 3px rgba(201, 165, 160, 0.25);
    }

    .login-btn {
        width: 100%;
        background: linear-gradient(135deg, #c9a5a0 0%, #d8b5b0 100%);
        color: #fff;
        border: none;
        padding: 14px;
        border-radius: 14px;
        font-size: 1.15em;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(201, 165, 160, 0.3);
        margin-top: 8px;
    }

    .login-btn:hover {
        background: linear-gradient(135deg, #d8b5b0 0%, #e5c5c0 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(201, 165, 160, 0.4);
    }

    .login-error {
        color: #e07070;
        font-size: 0.95em;
        font-weight: 600;
        margin-top: 12px;
        min-height: 22px;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #c9a5a0;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .header h1 {
            font-size: 2em;
        }

        .nav-buttons {
            grid-template-columns: 1fr;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        .pie-chart-container {
            flex-direction: column;
        }

        .pie-chart {
            width: 200px;
            height: 200px;
        }
    }
</style>


</head>
<body>
    <!-- ××¡×š ×¡×™×¡××” -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-icon">âš”ï¸</div>
            <h1>×—×˜× ×•×¢×•× ×©×•</h1>
            <p class="login-subtitle">×§×•×¨×¡ ××¨×™××œ ××—×–×•×¨ ×™×“</p>
            <input type="password" class="login-input" id="passwordInput" placeholder="×”×›× ×¡×™ ×¡×™×¡××”..." oninput="clearError()" onkeydown="if(event.key==='Enter') checkPassword()">
            <button class="login-btn" onclick="checkPassword()">ğŸ”“ ×›× ×•×¡</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>


<!-- ğŸ” ×¡×™×¡××” - Script × ×¤×¨×“, ×¢×•×‘×“ ×œ×‘×“ ×•×œ× ×ª×œ×•×™ ×‘-Firebase -->
<script>
    (function() {
        const CORRECT_PASSWORD = "2026";

        // ×‘×“×™×§×” ××•×˜×•××˜×™×ª ×× ×›×‘×¨ × ×›× ×¡
        if (sessionStorage.getItem('authenticated') === 'true') {
            document.getElementById('loginScreen').classList.add('hidden');
        }

        window.checkPassword = function() {
            const input = document.getElementById('passwordInput').value.trim();
            if (input === CORRECT_PASSWORD) {
                sessionStorage.setItem('authenticated', 'true');
                document.getElementById('loginScreen').classList.add('hidden');
            } else {
                document.getElementById('loginError').textContent = 'âŒ ×”×¡×™×¡××” ×œ× × ×›×•× ×”, × ×¡×™ ×©×•×‘';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        };

        window.clearError = function() {
            document.getElementById('loginError').textContent = '';
        };
    })();
</script>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>
            <span class="header-icon">âš”ï¸</span>
            ×—×˜× ×•×¢×•× ×©×•
            <span class="header-icon">âš”ï¸</span>
        </h1>
        <p>×§×•×¨×¡ ××¨×™××œ ××—×–×•×¨ ×™×“</p>
    </div>

    <div class="nav-buttons">
        <button class="nav-btn active" onclick="showSection('add')">
            ğŸ“ ×”×•×¡×¤×ª ×“×™×•×•×—
        </button>
        <button class="nav-btn" onclick="showSection('stats')">
            ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª
        </button>
        <button class="nav-btn" onclick="showSection('table')">
            ğŸ“‹ ×˜×‘×œ×” ×›×œ×œ×™×ª
        </button>
    </div>

    <div id="add-section" class="content-section active">
        <h2 class="section-title">ğŸ“ ×”×•×¡×¤×ª ×“×™×•×•×— ×—×“×©</h2>
        <div id="message" class="message"></div>
        <form id="reportForm">
            <div class="form-group">
                <label for="soldierName">×©× ×”×—×™×™×œ ×”××œ× *</label>
                <input type="text" id="soldierName" placeholder="×©× ×¤×¨×˜×™ + ×©× ××©×¤×—×”" required>
            </div>

            <div class="form-group">
                <label for="department">×©×™×•×š ××’××ª×™ *</label>
                <select id="department" required>
                    <option value="">×‘×—×¨ ××’××”...</option>
                    <option value="×©×˜×—">×©×˜×—</option>
                    <option value="×ª××´×">×ª××´×</option>
                    <option value="×™×¢×“×™×">×™×¢×“×™×</option>
                    <option value="×“××˜×">×“××˜×</option>
                </select>
            </div>

            <div class="form-group">
                <label>×¡×•×’ *</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="sampling" name="type" value="×—' ×“×™×’×•×" required>
                        <label for="sampling">×—' ×“×™×’×•×</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="report" name="type" value="×“×™×•×•×—" required>
                        <label for="report">×“×™×•×•×—</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="reason">×¤×™×¨×•×˜ / ×”×¢×¨×•×ª *</label>
                <textarea id="reason" placeholder="×¤×¨×˜ ××ª ×”×¡×™×‘×” ××• ×”×•×¡×£ ×”×¢×¨×•×ª..." required></textarea>
            </div>

            <button type="submit" class="submit-btn">
                ğŸ’¾ ×©××•×¨ ×“×™×•×•×—
            </button>
        </form>
    </div>

    <div id="stats-section" class="content-section">
        <h2 class="section-title">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
        
        <div class="soldier-search">
            <label for="soldierSearch" style="margin-bottom: 10px; display: block;">ğŸ” ×—×™×¤×•×© ×—×™×™×œ</label>
            <input type="text" 
                   id="soldierSearch" 
                   class="search-input" 
                   placeholder="×”×§×œ×“ ×©× ×—×™×™×œ ×œ×—×™×¤×•×©..."
                   oninput="searchSoldier(this.value)">
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="stats-container" id="statsContainer"></div>
    </div>

    <div id="table-section" class="content-section">
        <h2 class="section-title">ğŸ“‹ ×˜×‘×œ×” ×›×œ×œ×™×ª</h2>
        
        <div class="filter-section">
            <div class="filter-title">ğŸ” ×¡×™× ×•×Ÿ ×“×™×•×•×—×™×</div>
            <div class="filter-grid">
                <div class="form-group">
                    <label for="filterDepartment">××’××”</label>
                    <select id="filterDepartment">
                        <option value="">×›×œ ×”××’××•×ª</option>
                        <option value="×©×˜×—">×©×˜×—</option>
                        <option value="×ª××´×">×ª××´×</option>
                        <option value="×™×¢×“×™×">×™×¢×“×™×</option>
                        <option value="×“××˜×">×“××˜×</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterDateFrom">××ª××¨×™×š</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="form-group">
                    <label for="filterDateTo">×¢×“ ×ª××¨×™×š</label>
                    <input type="date" id="filterDateTo">
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="filter-btn" onclick="applyFilter()">ğŸ” ×¡× ×Ÿ</button>
                <button class="clear-filter-btn" onclick="clearFilter()">âœ–ï¸ × ×§×” ×¡×™× ×•×Ÿ</button>
            </div>
        </div>

        <div class="table-wrapper" id="tableContainer"></div>
    </div>
</div>

<script>
    // ×”×’×“×¨×•×ª Firebase - ××—×•×‘×¨ ×œ×¤×¨×•×™×§×˜ arielgreenflags
    const firebaseConfig = {
        apiKey: "AIzaSyCoa5zTyEfXAnDN4WZ1veJ4tlnNX0jfmTI",
        authDomain: "arielgreenflags.firebaseapp.com",
        databaseURL: "https://arielgreenflags-default-rtdb.firebaseio.com",
        projectId: "arielgreenflags",
        storageBucket: "arielgreenflags.firebasestorage.app",
        messagingSenderId: "591533362629",
        appId: "1:591533362629:web:6770a5720e0d6145568fac",
        measurementId: "G-T17ZSY9Z3K"
    };

    // Initialize Firebase
    let database;
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log('Firebase initialized successfully');
    } catch (error) {
        console.error('Firebase initialization error:', error);
        alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ××¡×“ ×”× ×ª×•× ×™×. ×× × ×‘×“×•×§ ××ª ×”×’×“×¨×•×ª Firebase.');
    }

    const reportsRef = database.ref('reports');
    let allReports = [];

    // Listen for real-time updates
    reportsRef.on('value', (snapshot) => {
        allReports = [];
        snapshot.forEach((childSnapshot) => {
            allReports.push({
                key: childSnapshot.key,
                ...childSnapshot.val()
            });
        });
        updateTable();
        updateStats();
    });

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    function showSection(section) {
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(`${section}-section`).classList.add('active');

        if (section === 'stats') {
            updateStats();
            document.getElementById('soldierSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
        } else if (section === 'table') {
            updateTable();
        }
    }

    document.getElementById('reportForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoading(true);

        const now = new Date();
        const report = {
            soldierName: document.getElementById('soldierName').value,
            department: document.getElementById('department').value,
            type: document.querySelector('input[name="type"]:checked').value,
            reason: document.getElementById('reason').value,
            date: now.toLocaleDateString('he-IL'),
            dateObj: now.toISOString().split('T')[0],
            time: now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
            arrivedToSampling: false,
            submittedReport: false,
            timestamp: now.getTime()
        };

        try {
            await reportsRef.push(report);
            showMessage('×”×“×™×•×•×— × ×©××¨ ×‘×”×¦×œ×—×”! âœ…', 'success');
            this.reset();
        } catch (error) {
            console.error('Error saving report:', error);
            showMessage('×©×’×™××” ×‘×©××™×¨×ª ×”×“×™×•×•×—', 'error');
        } finally {
            showLoading(false);
        }
    });

    function applyFilter() {
        updateTable(true);
    }

    function clearFilter() {
        document.getElementById('filterDepartment').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        updateTable(false);
    }

    function searchSoldier(searchTerm) {
        const searchResults = document.getElementById('searchResults');
        
        if (!searchTerm.trim()) {
            searchResults.innerHTML = '';
            return;
        }

        const soldierStats = {};
        
        allReports.forEach(report => {
            if (!soldierStats[report.soldierName]) {
                soldierStats[report.soldierName] = {
                    department: report.department,
                    sampling: 0,
                    reports: 0,
                    arrivedCount: 0,
                    submittedCount: 0
                };
            }
            if (report.type === '×—\' ×“×™×’×•×') {
                soldierStats[report.soldierName].sampling++;
                if (report.arrivedToSampling) soldierStats[report.soldierName].arrivedCount++;
            } else {
                soldierStats[report.soldierName].reports++;
                if (report.submittedReport) soldierStats[report.soldierName].submittedCount++;
            }
        });

        const matchedSoldiers = Object.entries(soldierStats).filter(([name, _]) => 
            name.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (matchedSoldiers.length === 0) {
            searchResults.innerHTML = '<div class="empty-state">×œ× × ××¦××• ×—×™×™×œ×™×</div>';
            return;
        }

        let html = '';
        matchedSoldiers.forEach(([name, stats]) => {
            html += `
                <div class="soldier-details" style="margin-top: 15px;">
                    <h4>${name}</h4>
                    <div class="detail-row">
                        <span class="detail-label">××’××”:</span>
                        <span class="detail-value">${stats.department}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">×¡×”"×› ×“×™×•×•×—×™×:</span>
                        <span class="detail-value">${stats.sampling + stats.reports}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">×—' ×“×™×’×•×:</span>
                        <span class="detail-value">${stats.sampling}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">×“×™×•×•×—×™×:</span>
                        <span class="detail-value">${stats.reports}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">×”×’×™×¢ ×œ×—' ×“×™×’×•×:</span>
                        <span class="detail-value">${stats.arrivedCount} ××ª×•×š ${stats.sampling}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">×”×’×™×© ×“×™×•×•×—:</span>
                        <span class="detail-value">${stats.submittedCount} ××ª×•×š ${stats.reports}</span>
                    </div>
                </div>
            `;
        });

        searchResults.innerHTML = html;
    }

    function createPieChart(soldierStats) {
        const soldiers = Object.entries(soldierStats);
        const total = soldiers.reduce((sum, [_, stats]) => sum + stats.sampling + stats.reports, 0);
        
        const colors = [
            '#c9a5a0', '#d8b5b0', '#e5c5c0', '#f0d5d0',
            '#a8b8ce', '#b8c8de', '#c8d8ee', '#d8e8fe',
            '#b8a8b8', '#c8b8c8', '#d8c8d8', '#e8d8e8'
        ];

        let html = '<div class="pie-chart-container">';
        html += '<svg class="pie-chart" viewBox="0 0 100 100" style="transform: rotate(-90deg)">';

        let currentAngle = 0;
        soldiers.forEach(([name, stats], index) => {
            const value = stats.sampling + stats.reports;
            const percentage = (value / total) * 100;
            const angle = (percentage / 100) * 360;
            
            const startX = 50 + 40 * Math.cos((currentAngle * Math.PI) / 180);
            const startY = 50 + 40 * Math.sin((currentAngle * Math.PI) / 180);
            const endX = 50 + 40 * Math.cos(((currentAngle + angle) * Math.PI) / 180);
            const endY = 50 + 40 * Math.sin(((currentAngle + angle) * Math.PI) / 180);
            
            const largeArc = angle > 180 ? 1 : 0;
            
            html += `
                <path class="pie-slice" 
                      d="M 50 50 L ${startX} ${startY} A 40 40 0 ${largeArc} 1 ${endX} ${endY} Z"
                      fill="${colors[index % colors.length]}"
                      onclick="showSoldierDetails('${name}')"
                      style="stroke: white; stroke-width: 0.5;">
                    <title>${name}: ${value} ×“×™×•×•×—×™× (${percentage.toFixed(1)}%)</title>
                </path>
            `;
            
            currentAngle += angle;
        });

        html += '</svg>';
        html += '<div id="soldierDetailsContainer" class="soldier-details">';
        html += '<h4>×œ×—×¥ ×¢×œ ×¤×œ×— ×‘×’×¨×£ ×œ×¨××•×ª ×¤×¨×˜×™×</h4>';
        html += '<p style="color: #999; text-align: center; margin-top: 10px;">×‘×—×¨ ×—×™×™×œ ××”×’×¨×£...</p>';
        html += '</div>';
        html += '</div>';

        return html;
    }

    function showSoldierDetails(soldierName) {
        const soldierReports = allReports.filter(r => r.soldierName === soldierName);
        
        const samplingCount = soldierReports.filter(r => r.type === '×—\' ×“×™×’×•×').length;
        const reportCount = soldierReports.filter(r => r.type === '×“×™×•×•×—').length;
        const department = soldierReports[0]?.department || '×œ× ×™×“×•×¢';
        
        const arrivedCount = soldierReports.filter(r => r.arrivedToSampling).length;
        const submittedCount = soldierReports.filter(r => r.submittedReport).length;

        let html = `
            <h4>${soldierName}</h4>
            <div class="detail-row">
                <span class="detail-label">××’××”:</span>
                <span class="detail-value">${department}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">×¡×”"×› ×“×™×•×•×—×™×:</span>
                <span class="detail-value">${samplingCount + reportCount}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">×—' ×“×™×’×•×:</span>
                <span class="detail-value">${samplingCount}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">×“×™×•×•×—×™×:</span>
                <span class="detail-value">${reportCount}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">×”×’×™×¢ ×œ×—' ×“×™×’×•×:</span>
                <span class="detail-value">${arrivedCount} ××ª×•×š ${samplingCount}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">×”×’×™×© ×“×™×•×•×—:</span>
                <span class="detail-value">${submittedCount} ××ª×•×š ${reportCount}</span>
            </div>
        `;

        document.getElementById('soldierDetailsContainer').innerHTML = html;
    }

    function updateStats() {
        const statsContainer = document.getElementById('statsContainer');

        if (allReports.length === 0) {
            statsContainer.innerHTML = '<div class="empty-state">××™×Ÿ ×“×™×•×•×—×™× ×¢×“×™×™×Ÿ</div>';
            return;
        }

        const soldierStats = {};
        allReports.forEach(report => {
            if (!soldierStats[report.soldierName]) {
                soldierStats[report.soldierName] = {
                    department: report.department,
                    sampling: 0,
                    reports: 0
                };
            }
            if (report.type === '×—\' ×“×™×’×•×') {
                soldierStats[report.soldierName].sampling++;
            } else {
                soldierStats[report.soldierName].reports++;
            }
        });

        let html = '<div class="chart-section">';
        html += '<h3>ğŸ“Š ×’×¨×£ ×¢×•×’×” - ×”×ª×¤×œ×’×•×ª ×“×™×•×•×—×™× ×œ×¤×™ ×—×™×™×œ</h3>';
        html += createPieChart(soldierStats);
        html += '</div>';

        statsContainer.innerHTML = html;
    }

    async function deleteReport(key) {
        if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×“×™×•×•×— ×–×”?')) {
            showLoading(true);
            try {
                await reportsRef.child(key).remove();
                showMessage('×”×“×™×•×•×— × ××—×§ ×‘×”×¦×œ×—×”', 'success');
            } catch (error) {
                console.error('Error deleting report:', error);
                showMessage('×©×’×™××” ×‘××—×™×§×ª ×”×“×™×•×•×—', 'error');
            } finally {
                showLoading(false);
            }
        }
    }

    async function toggleArrivedToSampling(key) {
        const report = allReports.find(r => r.key === key);
        if (report && report.type === '×—\' ×“×™×’×•×') {
            try {
                await reportsRef.child(key).update({
                    arrivedToSampling: !report.arrivedToSampling
                });
            } catch (error) {
                console.error('Error updating report:', error);
            }
        }
    }

    async function toggleSubmittedReport(key) {
        const report = allReports.find(r => r.key === key);
        if (report && report.type === '×“×™×•×•×—') {
            try {
                await reportsRef.child(key).update({
                    submittedReport: !report.submittedReport
                });
            } catch (error) {
                console.error('Error updating report:', error);
            }
        }
    }

    function updateTable(applyFilters = false) {
        let reports = [...allReports];
        const tableContainer = document.getElementById('tableContainer');

        if (applyFilters) {
            const filterDept = document.getElementById('filterDepartment').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;

            if (filterDept) {
                reports = reports.filter(r => r.department === filterDept);
            }

            if (filterDateFrom) {
                reports = reports.filter(r => {
                    const reportDate = r.dateObj || r.date;
                    return reportDate >= filterDateFrom;
                });
            }

            if (filterDateTo) {
                reports = reports.filter(r => {
                    const reportDate = r.dateObj || r.date;
                    return reportDate <= filterDateTo;
                });
            }
        }

        if (reports.length === 0) {
            tableContainer.innerHTML = '<div class="empty-state">××™×Ÿ ×“×™×•×•×—×™× ×œ×”×¦×’×”</div>';
            return;
        }

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>×©× ×”×—×™×™×œ</th>
                        <th>××’××”</th>
                        <th>×¡×•×’</th>
                        <th>×¤×™×¨×•×˜</th>
                        <th>×”×× ×”×’×™×¢ ×œ×—' ×“×™×’×•×?</th>
                        <th>×”×× ×”×’×™×© ×“×™×•×•×—?</th>
                        <th>×ª××¨×™×š</th>
                        <th>×©×¢×”</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody>
        `;

        reports.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(report => {
            const arrivedCell = report.type === '×—\' ×“×™×’×•×' 
                ? `<div class="checkbox-container">
                    <input type="checkbox" ${report.arrivedToSampling ? 'checked' : ''} 
                           onclick="toggleArrivedToSampling('${report.key}')">
                   </div>`
                : '<span class="not-relevant">×œ× ×¨×œ×•×•× ×˜×™</span>';

            const submittedCell = report.type === '×“×™×•×•×—' 
                ? `<div class="checkbox-container">
                    <input type="checkbox" ${report.submittedReport ? 'checked' : ''} 
                           onclick="toggleSubmittedReport('${report.key}')">
                   </div>`
                : '<span class="not-relevant">×œ× ×¨×œ×•×•× ×˜×™</span>';

            html += `
                <tr>
                    <td><strong>${report.soldierName}</strong></td>
                    <td>${report.department}</td>
                    <td><strong>${report.type}</strong></td>
                    <td>${report.reason}</td>
                    <td class="checkbox-cell">${arrivedCell}</td>
                    <td class="checkbox-cell">${submittedCell}</td>
                    <td>${report.date}</td>
                    <td>${report.time}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteReport('${report.key}')">ğŸ—‘ï¸ ××—×§</button>
                    </td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>
        `;

        tableContainer.innerHTML = html;
    }
</script>


</body>
</html>
